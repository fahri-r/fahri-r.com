---
import { Icon } from 'astro-icon/components';
import { Button } from '../shared/button';
import { cn } from '~/lib/utils';
import { ButtonGroup } from '../shared/button-group';

interface Props {
	className?: string;
}

const { className } = Astro.props;
---

<ButtonGroup className={cn('font-heading w-full', className)}>
	<Button id="dark-button" variant="outline" className="w-[50%] text-[0.6rem]">
		<Icon name="moon" class="size-4" />
		<span class="self-center">Dark</span>
	</Button>
	<Button id="light-button" variant="outline" className="w-[50%] text-[0.6rem]">
		<Icon name="sun" class="size-4" />
		<span class="self-center">Light</span>
	</Button>
</ButtonGroup>

<script is:inline data-astro-rerun>
	(() => {
		const theme = (() => {
			const stored = localStorage?.getItem('theme') ?? '';
			if (['dark', 'light'].includes(stored)) return stored;
			return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
		})();

		document.documentElement.setAttribute('data-theme', theme);
		window.localStorage.setItem('theme', theme);

		if (theme === 'dark') {
			const btn = document.getElementById('dark-button');
			btn.disabled = true;
		} else {
			const btn = document.getElementById('light-button');
			btn.disabled = true;
		}
	})();
</script>

<script>
	function handleToggleClick(theme: 'dark' | 'light') {
		const element = document.documentElement;

		element.classList.add('[&_*]:transition-none');
		element.setAttribute('data-theme', theme);
		window.getComputedStyle(element).getPropertyValue('opacity');

		requestAnimationFrame(() => {
			element.classList.remove('[&_*]:transition-none');
		});

		localStorage.setItem('theme', theme);

		if (theme === 'dark') {
			const darkBtn = document.getElementById('dark-button') as HTMLButtonElement;
			darkBtn.disabled = true;

			const lightBtn = document.getElementById('light-button') as HTMLButtonElement;
			lightBtn.disabled = false;
		} else {
			const darkBtn = document.getElementById('light-button') as HTMLButtonElement;
			darkBtn.disabled = true;

			const lightBtn = document.getElementById('dark-button') as HTMLButtonElement;
			lightBtn.disabled = false;
		}
	}

	function initThemeToggle() {
		document
			.getElementById('dark-button')
			?.addEventListener('click', () => handleToggleClick('dark'));
		document
			.getElementById('light-button')
			?.addEventListener('click', () => handleToggleClick('light'));
	}

	initThemeToggle();

	document.addEventListener('astro:after-swap', () => {
		const storedTheme = localStorage.getItem('theme') || 'light';
		const element = document.documentElement;

		element.classList.add('[&_*]:transition-none');
		window.getComputedStyle(element).getPropertyValue('opacity');
		element.setAttribute('data-theme', storedTheme);

		requestAnimationFrame(() => {
			element.classList.remove('[&_*]:transition-none');
		});

		initThemeToggle();
	});
</script>

---
import { buildURLToHTMLMap, isAmazonURL, isTweetURL } from '~/libs/blog-helper';
import type * as interfaces from '~/interfaces/notion/block.interface';
import Paragraph from '~/components/shared/notion-blocks/paragraph.astro';
import Heading1 from '~/components/shared/notion-blocks/heading1.astro';
import Heading2 from '~/components/shared/notion-blocks/heading2.astro';
import Heading3 from '~/components/shared/notion-blocks/heading3.astro';
import Divider from '~/components/shared/notion-blocks/divider.astro';
import Embed from '~/components/shared/notion-blocks/embed.astro';
import Quote from '~/components/shared/notion-blocks/quote.astro';
import Bookmark from '~/components/shared/notion-blocks/bookmark.astro';
import Callout from '~/components/shared/notion-blocks/callout.astro';
import Video from '~/components/shared/notion-blocks/video.astro';
import Image from '~/components/shared/notion-blocks/image.astro';
import File from '~/components/shared/notion-blocks/file.astro';
import Toggle from '~/components/shared/notion-blocks/toggle.astro';
import Table from '~/components/shared/notion-blocks/table.astro';
import TableOfContents from '~/components/shared/notion-blocks/table-of-contents.astro';
import SyncedBlock from '~/components/shared/notion-blocks/synced-block.astro';
import LinkToPage from '~/components/shared/notion-blocks/link-to-page.astro';
import Code from '~/components/shared/notion-blocks/code.astro';
import Equation from '~/components/shared/notion-blocks/equation.astro';
import BulletedListItems from '~/components/shared/notion-blocks/bulleted-list.astro';
import NumberedListItems from '~/components/shared/notion-blocks/numbered-list.astro';
import ToDoListItems from '~/components/shared/notion-blocks/to-do-list.astro';

interface Props {
	blocks: interfaces.Block[];
	headings: (interfaces.Heading1 | interfaces.Heading2 | interfaces.Heading3)[];
	level?: number;
}

const { blocks: rawBlocks, headings = [], level = 1 } = Astro.props;

// Process blocks on the server
let blocks: interfaces.Block[] = [];
let listGroups: interfaces.List[] = [];
let bookmarkURLMap: { [key: string]: string } | undefined;

let prevBlock: interfaces.Block | undefined;
let currentListGroup: interfaces.Block[] = [];
let bookmarkURLs: URL[] = [];

rawBlocks.map((block) => {
	const isListBlock =
		block.type === 'bulleted_list_item' ||
		block.type === 'numbered_list_item' ||
		block.type === 'to_do';

	// Handle list items grouping
	if (isListBlock) {
		if (!prevBlock || prevBlock.type !== block.type || !currentListGroup.length) {
			currentListGroup.push(block);
			blocks.push(block); // Only add first item of each group
		} else {
			currentListGroup.push(block);
		}
	}
	// Handle non-list blocks
	else {
		// Push any pending list group
		if (currentListGroup.length > 0) {
			listGroups.push({
				type: getListType(prevBlock!.type),
				listItems: [...currentListGroup]
			});
			currentListGroup = [];
		}
		blocks.push(block);
	}

	// Handle bookmark URLs
	if (block.type === 'bookmark' || block.type === 'link_preview' || block.type === 'embed') {
		try {
			const url = new URL(block.url);
			if (!isTweetURL(url) && !isAmazonURL(url)) {
				bookmarkURLs.push(url);
			}
		} catch (err) {
			console.error('Invalid URL:', block.url, err);
		}
	}

	prevBlock = block;
});

// Build URL map (async operation)
if (bookmarkURLs.length > 0) {
	bookmarkURLMap = await buildURLToHTMLMap(bookmarkURLs);
}

if (currentListGroup.length > 0) {
	listGroups.push({
		type: getListType(prevBlock!.type),
		listItems: [...currentListGroup]
	});
	currentListGroup = [];
}

// Helper function to determine list type
function getListType(itemType: string): 'bulleted_list' | 'numbered_list' | 'to_do_list' {
	switch (itemType) {
		case 'bulleted_list_item':
			return 'bulleted_list';
		case 'numbered_list_item':
			return 'numbered_list';
		default:
			return 'to_do_list';
	}
}
---

{
	blocks.map((block) => {
		switch (block.type) {
			case 'paragraph':
				return <Paragraph block={block} headings={headings} />;
			case 'heading_1':
				return <Heading1 block={block} headings={headings} />;
			case 'heading_2':
				return <Heading2 block={block} headings={headings} />;
			case 'heading_3':
				return <Heading3 block={block} headings={headings} />;
			case 'divider':
				return <Divider />;
			case 'quote':
				return <Quote block={block} headings={headings} />;
			case 'embed':
				return <Embed block={block} urlMap={bookmarkURLMap!} />;
			case 'bookmark':
			case 'link_preview':
				return <Bookmark block={block} urlMap={bookmarkURLMap!} />;
			case 'callout':
				return <Callout block={block} headings={headings} />;
			case 'video':
				return <Video block={block} />;
			case 'image':
				return <Image block={block} />;
			case 'file':
				return <File block={block} />;
			case 'toggle':
				return <Toggle block={block} headings={headings} />;
			case 'table':
				return <Table block={block} />;
			case 'table_of_contents':
				return <TableOfContents block={block} headings={headings} />;
			case 'synced_block':
				return <SyncedBlock block={block} headings={headings} />;
			case 'link_to_page':
				return <LinkToPage block={block} />;
			case 'code':
				return <Code block={block} />;
			case 'equation':
				return <Equation block={block} />;
			case 'bulleted_list_item': {
				const bulletedList = listGroups.find(
					(x) => x.type === 'bulleted_list' && x.listItems.some((item) => item.id === block.id)
				);

				if (!bulletedList) return;

				return (
					<BulletedListItems list={bulletedList as interfaces.BulletedList} headings={headings} />
				);
			}
			case 'numbered_list_item': {
				const numberedList = listGroups.find(
					(x) => x.type === 'numbered_list' && x.listItems.some((item) => item.id === block.id)
				);

				if (!numberedList) return;

				return (
					<NumberedListItems
						list={numberedList as interfaces.NumberedList}
						level={level}
						headings={headings}
					/>
				);
			}
			case 'to_do': {
				const toDoList = listGroups.find(
					(x) => x.type === 'to_do_list' && x.listItems.some((item) => item.id === block.id)
				);

				if (!toDoList) return;

				return <ToDoListItems list={toDoList as interfaces.ToDoList} headings={headings} />;
			}
			default:
				return;
		}
	})
}
